<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flappy</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.3.0/socket.io.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.0.0/jquery.js"></script>
    <script src="../static/modalF.js"></script>
    <script src="../static/p5.js"></script>
    <script src="../static/p5.sound.min.js"></script>
    <script src="../static/ml5.min.js"></script>
    <link rel="stylesheet" type="text/css" href="../static/style.css">

    <!---
 <style>
        input[type="color"] {
            width: 20px;
            height: 20px;
            border-radius: 100%;
            background-color: white;
            border: none;
        }

        form {
            padding: 5px;
        }

        .m-modal {
            display: none;
        }

    </style>

-->


</head>

<body class="teal">






    <div class="row">
        <div class="col s12 m12 l12 center">
            <h1 class="white-text">Flappy Arm</h1>
        </div>
    </div>

    <div class="row">
        <div class="col s8 m6 14 offset-s2 offset-m3 offset-14 white z-depth-2">
            <form action="">
                <div class="row">
                    <div class="col s12 m12 l12 center">
                        <input type="text" name="center" placeholder="Nickname" required>
                    </div>
                </div>
                <div class="row">
                    <div class="col s12 m12 l12 center">
                        <button type="submit" class="btn red m-open" m-open="canvas">Send</button>
                    </div>
                </div>
            </form>
        </div>
    </div>


    <div class="m-modal" m-modal="canvas">
        <div class="m-body ">
            <div class="row">
                <div class="col s6 m6 l6" id="jugadores">

                </div>

                <div class="col s6 m6 l6" id="canvas">
                </div>

            </div>
        </div>


    </div>


    <script type="text/javascript">


        var video;
        var c;
        var socket = io.connect('http://' + document.domain + ':' + location.port);
        var users = [];
        var myUser = {};
        var x = 0;
        var y = 0;


        $(document).ready(function () {
            $('form').on('submit', function (e) {
                e.preventDefault();

                var name = $('input[type="text"]').val();
                myUser.name = name;
                myUser.id = socket.id;
                myUser.x = 0;
                myUser.y = 0;
                $('.m-open').modalF({ color: "#333" });
                $('button').trigger('click');
                c.show();

                video.show();

                socket.emit('addUser', myUser);
            })


            socket.on('users', function (data) {
                users = data
            });

        })

        let bird;
        let barriers;
        let landscape;

        let isGameOver = false;
        let hasGameBegun = false;
        let score = 0;
        let hiScore = -1;
        let lastHiScore = -1;
        let stage = 1;

        let startingSpeed = 4;
        let arcadeFont;
        let isInvincible = false; // change this to be true to become invincible

        let minDistanceBetweenPipes;
        let nextSpawnDistance;


        let poseNet;
        let human = null;
        let armFlap = null;
        let drawDebugInfo = false; // set to true to turn on debug info
        let skeleton = null;


        function setup() {

            c = createCanvas(1000, 480);
            c.parent('canvas');




            //createCanvas(640, 480);
            video = createCapture(VIDEO);
            video.parent('canvas');

            c.hide();
            video.hide();

            minDistanceBetweenPipes = width / 2;
            //textFont(arcadeFont); 

            resetGame();

            // stop game loop until space bar hit to begin
            noLoop();

            poseNet = ml5.poseNet(video, onModelReady); //call onModelReady when setup
            poseNet.on('pose', onPoseDetected); // call onPoseDetected when pose detected
        }

        function onModelReady() {
            print("The PoseNet model is ready...");
        }

        function onPoseDetected(poses) {
            // poses can contain an array of bodies (because PoseNet supports
            // recognition for *multiple* human bodies at the same time
            // however, for this demo, we are interested in only one human body
            // which is at poses[0]
            human = poses[0];
        }

        function createBarrier() {
            return new Barrier(startingSpeed + stage * 0.5, stage - 0.5);
        }

        function resetGame() {
            score = 0;
            isGameOver = false;

            landscape = new Background();
            bird = new Bird(64, height / 2);
            armFlap = new ArmFlap(bird);
            barriers = [createBarrier()];
            nextSpawnDistance = random(minDistanceBetweenPipes, width - width / 4);
            //nextSpawnDistance = random(width, width * 2);
            loop();
        }

        function draw() {
            
            background(220);

            textSize(32);
            //text("Jugadores", 50, 50);






            landscape.update();
            landscape.draw();

            if (barriers.length <= 0 || width - barriers[barriers.length - 1].x >= nextSpawnDistance) {
                barriers.push(createBarrier());
                nextSpawnDistance = random(minDistanceBetweenPipes, width * 1.2);
            }

            // loop through all the barriers and update them
            for (let i = barriers.length - 1; i >= 0; i--) {
                barriers[i].update();
                barriers[i].draw();

                //if we hit the barrier, end game
                if (barriers[i].checkIfHitsBird(bird) && isInvincible == false) {
                    isGameOver = true;

                    lastHiScore = hiScore;
                    if (hiScore < score) {
                        hiScore = score;
                    }

                    noLoop(); // game is over, stop game loop
                }

                // if we successfully pass the barrier, increase the score
                if (barriers[i].pastBird === false && barriers[i].checkIfPastBird(bird)) {
                    score++;

                    if (score % 10 == 0) {
                        stage++;
                    }
                }

                // remove barriers that have gone off the screen
                if (barriers[i].getRight() < 0) {
                    barriers.splice(i, 1);
                }
            }

            bird.update();
            bird.draw();

            armFlap.update(human);
            if (drawDebugInfo) {
                drawPose();
                armFlap.draw();
            }
            drawScore();
        }

        function drawPose() {
            push();
            tint(128, 50);
            if (video) {
                image(video, 0, 0); // draw the video to screen
            }

            noStroke(); // turn off drawing outlines of shapes

            //if a human has been detected, draw overlay shapes!
            if (human != null) {

                



                /*
                for (let keypoint of human.pose.keypoints) {
                    fill(255, 255, 255, 50);
                    ellipse(keypoint.position.x, keypoint.position.y, 15);
                    textSize(10);
                    text(keypoint.part, keypoint.position.x, keypoint.position.y);
                }
                */



            }






            pop();
        }

        function drawScore() {

            fill(0);
            textAlign(LEFT);
            textSize(15);
            text('Score:' + score, 10, 20);

            let stageStr = 'Stage:' + stage;
            text(stageStr, width - textWidth(stageStr) - 5, 20);

            if (hiScore > 0) {
                let hiScoreStr = 'Hi-Score:' + hiScore;
                text(hiScoreStr, width / 2 - textWidth(hiScoreStr) / 2, 20);
            }

            if (isGameOver) {

                // dark overlay
                fill(0, 0, 0, 100);
                rect(0, 0, width, height);

                // draw gameover text
                textAlign(CENTER);
                textSize(35);
                fill(255);
                text('GAME OVER!', width / 2, height / 3);


                textSize(12);
                let yText = height / 2;

                if (hiScore > lastHiScore && hiScore > 0) {
                    text('New Hi-Score of ' + hiScore + '!', width / 2, yText);
                    yText += 30;
                }

                text('Press SPACE BAR to play again.', width / 2, yText);
            } else if (hasGameBegun == false) {
                // if we're here, then the game has yet to begin for the first time

                // dark overlay
                fill(0, 0, 0, 100);
                rect(0, 0, width, height);

                // draw game over text
                textAlign(CENTER);
                textSize(15);
                fill(255);
                text('Press SPACE BAR to play!', width / 2, height / 3);
            }

        }

        function keyPressed() {

            // check for special states (game over or if game hasn't begun)
            if (isGameOver == true && key == ' ') {
                resetGame();
            } else if (hasGameBegun == false && key == ' ') {
                hasGameBegun = true;
                loop();
            }
        }

        var sketch_players = function (p) {

            p.setup = function () {

                var players_canva = p.createCanvas(500, 1000);
                players_canva.parent('#jugadores');
            };

            p.draw = function () {

                p.textSize(45)
                p.text("Jugadores", 80, 50)
                p.fill("#fff");

                $.each(users, function (index, u) {
                    p.fill("#fff");
                    p.textSize(24);
                    p.text(u.name, u.x, u.y);


                })
            };
        };

        var sk_players = new p5(sketch_players);

    </script>









    <script src="../static/shape.js"></script>
    <script src="../static/barrier.js"></script>
    <script src="../static/bird.js"></script>
    <script src="../static/armflap.js"></script>
    <script src="../static/background.js"></script>



</body>

</html>